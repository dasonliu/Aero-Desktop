# Aero Desktop 更新说明 - 2025年5月23日

## 1. 功能需求
本项目旨在构建一个高拟真、智能化的 Web 桌面系统。本次更新核心需求如下：
*   **沉浸式入场**: 实现图标从屏幕外随机坐标飞入预设网格的动效。
*   **智能快捷方式工作室 (Shortcut Studio)**:
    *   支持通过 URL 自动识别 brand。
    *   集成 Gemini AI 视觉生成，提供“看板娘 (Kanban Girl)”、“赛博汽车”、“动猫”等多种艺术风格选择。
    *   同步生成适配 Icon (1:1), Card (3:4), Gallery (9:16) 三种比例的视觉资产。
*   **多态布局切换**: 允许用户在三种视觉模式间自由切换，并支持右键“自动排列”功能。
*   **用户自定义资产**: 在 AI 生成的基础上，支持用户手动上传并替换任意比例的缩略图。
*   **存储冗余设计**: 针对 LocalStorage 的 5MB 限制，实现资产自动压缩与故障降级机制。

## 2. 实现方式和步骤

### 2.1 视觉资产生成流程
1.  **风格定义**: 预设 `AI_STYLES` 配置对象，包含图标及对应的 Prompt 片段。
2.  **多轮请求**: 利用 `gemini-2.5-flash-image` 模型，根据不同 Aspect Ratio（1:1, 3:4, 9:16）串行或并行请求图像。
3.  **图像优化**: 调用 `Canvas API` 将生成的 PNG 图像转换为 WebP 格式，并进行 0.6 质量压缩，显著降低 Base64 字符串长度。

### 2.2 布局引擎实现
1.  **Context 驱动**: 使用 `OSContext` 统一管理 `desktopItems` 的坐标状态。
2.  **网格计算**: `reorganizeGrid` 函数根据当前 `window.innerWidth` 和选定的 `layoutMode` 动态计算每行单元格数量及偏移量。
3.  **动画执行**: 利用 `framer-motion` 的 `layout` prop 或 `animate` 属性实现坐标变更时的平滑过渡。

### 2.3 手动上传逻辑
1.  **隐藏 Input**: 为每种比例配置隐藏的 `<input type="file" />`。
2.  **FileReader 转换**: 将上传文件转为 DataURL，经过 `resizeImage` 统一尺寸和格式后再存入状态。

## 3. 注意事项
*   **API 密钥安全**: 必须通过 `process.env.API_KEY` 获取密钥，不得硬编码在前端逻辑中。
*   **存储配额**: Base64 图像极大，若 LocalStorage 溢出，程序会触发 `OSContext` 中的降级逻辑（仅保留 Icon），防止黑屏崩溃。
*   **性能瓶颈**: 桌面图标超过 20 个时，复杂的 `AnimatePresence` 可能会造成卡顿，建议保持资产简洁。
*   **SDK 使用**: 务必使用 `@google/genai` 的最新标准，避免使用已废弃的 `GoogleGenerativeAI` 构造函数。